---
title: "Raman Plots"
output:   
  html_notebook: 
    toc: true
    toc_float: true
author: Candace Savonen
date: 2020
---

## Set Up

This uses algorithms from `baselineWavelet`, so we need to install this if 
it hasn't been installed. 

```{r echo=FALSE}
if (!("tidyverse" %in% installed.packages())){
  install.packages("tidyverse")
}

if (!("baselineWavelet" %in% installed.packages())){
  package_file <- file.path("util", "zmzhang-baselineWavelet-4.0.2-9.zip")
  
  # Download the package
  download.file("https://github.com/zmzhang/baselineWavelet/archive/981c41095f5b4aaedf06bbcb2f4366acd467d1f0.zip", 
                destfile = package_file)
  3 
  install.packages(package_file, 
                   repos = NULL, type = "source")
}

if (!("patchwork" %in% installed.packages())){
  devtools::install_github("thomasp85/patchwork")
}
```

Attach libraries we need. 

```{r}
# magrittr pipe
`%>%` <- dplyr::`%>%`

library(baselineWavelet)
library(Matrix)
library(patchwork)
```

Import special functions. 

```{r}
source(file.path("util", "read_n_correct.R"))
source(file.path("util", "plotting_wrappers.R"))
```

### Directories and Files

The plots we make will be saved to this directory.

```{r}
# Path to output directory
plots_dir <- "plots"

# Create the plots_dir if it does not exist
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}

# Call the plot what you would like it to be saved as
plot_filename <- "raman_plot.png"
```

Any files that are in this directory will be run. 

```{r}
# Path to input directory
input_dir <- "input_data"

# Check that what you supplied exists
dir.exists(input_dir)
```

Get all the file names!

```{r}
# Get the list of files from here
input_files <- list.files(input_dir, 
                          pattern="^.*\\.(csv|CSV)$", 
                          full.names = TRUE)

# Test if all files found?
all(sapply(input_files, file.exists))
```

Collect experiment information from the file names.

```{r}
input_df <- data.frame(input_files) %>%
  # Split up file names into multiple columns so we can handle it easier
  tidyr::separate(input_files, sep = "_", 
                  into = c("file_path", 
                           "name", 
                           "pressure_pt", 
                           "pressure", 
                           "wavelength"
                           )) %>% 
  # Save input file paths as their own column too
  dplyr::mutate(input_files = input_files, 
                pressure = as.numeric(stringr::str_remove(pressure, " GPa"))) %>% 
  # Filter to only sets that have P (not dP)
  dplyr::filter(grepl("^P", pressure_pt)) %>%
  # Select only the columns we'll move forward with
  dplyr::select(input_files, 
                pressure_pt, 
                pressure, 
                wavelength
                )

input_df
```

Neaten up the wavelength column. 

```{r}
input_df <- input_df %>%
  # Make the wavelength column only have the wavelength -- drop the dates
  dplyr::mutate(wavelength = as.numeric(stringr::word(wavelength, sep = " ", 2))) %>% 
  # Order the data.frame by the wavelength 
  dplyr::arrange(pressure, wavelength)

input_df
```

Where there's a 2800 and a 3200 for an individual pressure, only keep the 3200 file. 

```{r}
too_many <- input_df %>%
  dplyr::group_by(pressure)%>%
  dplyr::summarize(n = dplyr::n()) %>% 
  dplyr::filter(n > 3) %>% 
  dplyr::pull(pressure)

input_df <- input_df %>% 
  dplyr::filter(!(pressure == too_many & wavelength == 2800))
```

Print out the final version of the data frame with the input files. 

```{r}
input_df
```

## Specify the pressures and ranges for each file

Name the pressures for each file and make a table that explains the 
samples being plotted. 

**Double check the table printed out that it has the accurate pressure and range labels.**

```{r}
# Make a data.frame with each samples' information
sample_df <- input_df %>%
  dplyr::mutate(wave_min = dplyr::recode(wavelength, 
                          "375" = 200, 
                          "2275" = 1500, 
                          "2800" = 2800, 
                          "3200" = 2800
                        ),
                wave_max = dplyr::recode(wavelength, 
                          "375" = 1310, 
                          "2275" = 1875, 
                          "2800" = 3500, 
                          "3200" = 3500)
                ) 

# Print out the table so it can be double checked
knitr::kable(sample_df %>% dplyr::select(pressure, wavelength, wave_min, wave_max))
```

## Run each data file through the correction algorithms

Use the specialized function to import and correct the data from each file.

```{r}
# Read, background correct, and identify peaks of each sample
corrected_datasets <- apply(sample_df, 1, 
                            function(file) {
                            read_n_correct(filename = file['input_files'], 
                                           wavenum_min = as.numeric(file['wave_min']),
                                           wavenum_max = as.numeric(file['wave_max']))
                              })

# Bring along the sample labels
names(corrected_datasets) <- paste0(sample_df$pressure, 
                            "GPa",
                            sample_df$wave_min,
                            "-", 
                            sample_df$wave_max,
                            each = "")
```

## Obtain a individual plot for each corrected dataset

```{r}
peak_plots <- lapply(corrected_datasets, 
                     plot_ind_peaks)

names(peak_plots) <- paste0(sample_df$pressure, 
                            "GPa",
                            sample_df$wave_min,
                            "-", 
                            sample_df$wave_max,
                            each = "")
```

## Assemble the main plot

Put together all the peak plots into one grid. 
Assemble by row. 

```{r}
n_rows <- 2
```

Assemble first row. 

```{r}
first_row <- 
  remove_y_axis(peak_plots$`2.914GPa200-1310`)  +
  remove_y_axis(peak_plots$`2.914GPa1500-1875`) + 
  remove_y_axis(peak_plots$`2.914GPa2800-3500`)
```

Assemble second row. 

```{r}
second_row <- 
  remove_axes(peak_plots$`5.48GPa200-1310`) +  
  remove_axes(peak_plots$`5.48GPa1500-1875`) +
  remove_axes(peak_plots$`5.48GPa2800-3500`)
```

### Combine rows

```{r}
ultimate_plot <- 
  add_text_labels(second_row, text = "5.48 GPa") /
  add_text_labels(first_row, text = "2.914 GPa")
```

## Add annotation labels

Declare x and y labels and main title. 

```{r}
# Declare the main title
main_title <- "The background-correction of Raman Spectra"

# Declare x label
x_lab <- "Wavelength / nm"

# Declare y label
y_lab <- "Raman Intensity/Arbitr. Units"
```

Set up the formatting of our x and y labels. 

```{r}
x_lab <- wrap_elements(grid::textGrob(x_lab)) + 
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(.001, .001, .001, .001), "cm")
    )

y_lab <- wrap_elements(grid::textGrob(y_lab, rot = 90)) + 
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(.01, .01, .01, .01), "cm")
    )
```

Tack on the axis labels first.

```{r}
ultimate_plot <- 
  # Start with y label
  (y_lab + ultimate_plot) +
   plot_layout(
    widths = c(0.15, 5) # Adjust spacing 
    ) 

ultimate_plot <- 
  (ultimate_plot / x_lab) + 
  # Adjust spacing 
  plot_layout(
    heights = c(5, 0.5) # Adjust spacing 
    )
```

Add title. 

```{r}
ultimate_plot <- ultimate_plot + 
  plot_annotation(
  title = ggplot2::element_text(main_title),
  )
```

Print out preview of the final plot. 

```{r}
ultimate_plot
```

Save plot to a png

```{r}
ggplot2::ggsave(
  filename = file.path(plots_dir, plot_filename), 
  plot = ultimate_plot, 
  width = 10)
```

## Session Info

```{r}
sessionInfo()
```

